<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WC 2026 FIXTURE AND SIM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-dark: #050505;
            --card-dark: #0f0f0f;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            
            /* DYNAMIC NEON */
            --neon: #00ff9d; 
            --neon-glow: rgba(0, 255, 157, 0.4);
            --neon-dim: rgba(0, 255, 157, 0.3);
            
            --sim-neon: #00d9ff; 
            --pen-neon: #ffaa00; 
            
            /* MEDALS */
            --gold: #ffd700;
            --bronze: #cd7f32;
            --error: #ff3333;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(255,255,255,0.03) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255,255,255,0.03) 0%, transparent 25%);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            transition: --neon 0.5s ease;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2 {
            text-align: center; text-transform: uppercase; letter-spacing: 4px;
            text-shadow: 0 0 10px var(--neon-glow); margin: 0;
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }
        h1 { margin-bottom: 20px; font-size: 2.5rem; color: var(--neon); }
        h2 { margin-top: 60px; padding-top: 20px; border-top: 1px solid var(--neon-dim); font-size: 1.8rem; color: var(--text-main); margin-bottom: 30px; }

        /* --- CONTROLS --- */
        .top-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }

        .cyber-btn {
            background: rgba(0,0,0,0.6); border: 1px solid var(--neon); color: var(--neon);
            padding: 10px 25px; font-family: inherit; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }
        .cyber-btn:hover:not(:disabled) { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon-glow); }
        .cyber-btn:disabled { border-color: #333; color: #555; cursor: not-allowed; background: rgba(0,0,0,0.2); box-shadow: none; }

        .btn-sim { border-color: var(--sim-neon); color: var(--sim-neon); }
        .btn-sim:hover:not(:disabled) { background: var(--sim-neon); color: #000; box-shadow: 0 0 20px var(--sim-neon); }

        .btn-danger { border-color: var(--error); color: var(--error); }
        .btn-danger:hover { background: var(--error); color: white; box-shadow: 0 0 20px var(--error); }

        @keyframes pulse-warn {
            0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 51, 51, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); }
        }
        .btn-update-required { background-color: rgba(255, 51, 51, 0.1); border-color: var(--error); color: var(--error); animation: pulse-warn 2s infinite; }
        
        @keyframes input-flash { 0% { background-color: var(--sim-neon); color: black; } 100% { background-color: #111; color: white; } }
        .sim-flash { animation: input-flash 0.5s ease-out; }

        /* --- LAYOUT --- */
        .groups-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 25px; max-width: 1600px; margin: 0 auto; }
        .bracket-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; max-width: 1400px; margin: 20px auto; align-items: flex-start; }

        /* --- CARDS --- */
        .card { background: var(--card-dark); border: 1px solid var(--neon-dim); border-left: 4px solid var(--neon); padding: 15px; transition: border-color 0.5s; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .group-title { color: var(--neon); font-weight: bold; border-bottom: 1px solid var(--neon-dim); padding-bottom: 8px; margin-bottom: 10px; transition: color 0.5s; }

        .match-list { display: flex; flex-direction: column; gap: 4px; }
        .match-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; font-size: 0.9rem; }
        .team-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-right { text-align: right; }
        .t-left { text-align: left; }

        .inputs-wrapper { display: flex; gap: 5px; padding: 0 10px; justify-content: center; min-width: 90px; }

        input[type="number"] { width: 38px; background: #111; border: 1px solid #444; color: #fff; text-align: center; font-family: inherit; font-weight: bold; font-size: 1rem; padding: 4px; border-radius: 3px; -moz-appearance: textfield; }
        input[type="number"]:focus { outline: none; border-color: var(--neon); box-shadow: 0 0 8px var(--neon-dim); }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-bottom: 10px; color: #ccc; }
        th { text-align: center; color: #777; font-weight: normal; border-bottom: 1px solid #333; padding: 4px; }
        td { text-align: center; padding: 4px; border-bottom: 1px solid #222; }
        td:first-child { text-align: left; color: #fff; }
        
        .q-1, .q-2 { border-left: 2px solid var(--neon); background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent); }
        .q-3 { border-left: 2px solid #555; }
        .q-best-3 { border-left: 2px solid var(--gold) !important; color: var(--gold) !important; background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }

        /* --- KNOCKOUT CARDS --- */
        .match-card { width: 100%; max-width: 480px; min-height: 145px; display: flex; flex-direction: column; gap: 10px; background: var(--card-dark); border: 1px solid var(--neon-dim); border-left: 4px solid var(--neon); padding: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: border-color 0.5s; }
        .m-header { font-size: 0.7rem; color: #888; display: flex; justify-content: space-between; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .m-body { display: flex; align-items: center; justify-content: space-between; font-size: 1.1rem; }

        .pen-section { display: none; border-top: 1px dashed #333; padding-top: 5px; margin-top: 5px; text-align: center; }
        .pen-label { font-size: 0.7rem; color: var(--pen-neon); letter-spacing: 2px; display: block; margin-bottom: 3px; }
        .inp-pen { border-color: #530; color: var(--pen-neon); width: 32px; font-size: 0.9rem; }
        .inp-pen.pen-error { border-color: var(--error); color: var(--error); box-shadow: 0 0 5px var(--error); }

        /* --- SPECIAL CARDS --- */
        .bronze-card { border-left-color: var(--bronze); border-color: rgba(205, 127, 50, 0.3); }
        .gold-card { border-left-color: var(--gold); border-color: rgba(255, 215, 0, 0.4); box-shadow: 0 0 30px rgba(255,215,0,0.1); transform: scale(1.05); margin: 10px; z-index: 10; }
        .gold-card .m-header { color: var(--gold); font-weight: bold; }
        .gold-card .team-name { font-weight: bold; font-size: 1.2rem; }

        /* --- CHAMPION MODAL --- */
        #champion-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #champ-name { font-size: 4rem; color: var(--gold); text-shadow: 0 0 40px var(--gold); margin: 20px 0; text-align: center; }
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 999; }
        
        #path-panel { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid var(--neon); 
            padding: 15px; 
            margin-top: 20px; 
            border-radius: 5px; 
            max-width: 900px; 
            width: 90vw; /* Mobile fix */
            max-height: 200px; 
            overflow-y: auto; 
            color: #eee; 
        }

        .stage-section { display: none; padding-bottom: 40px; }
        .actions-row { width: 100%; display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }

        @media (max-width: 600px) {
            input[type="number"] { width: 30px; font-size: 0.9rem; }
            .match-card { padding: 12px; max-width: 100%; }
            .team-name { font-size: 0.85rem; }
            .inputs-wrapper { gap: 3px; min-width: 70px; }
            .cyber-btn { padding: 8px 16px; font-size: 0.75rem; letter-spacing: 0.5px; }
            h1 { font-size: 1.6rem; letter-spacing: 2px; margin-bottom: 10px; }
            h2 { font-size: 1.2rem; margin-top: 30px; }
            #champ-name { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

    <div id="champion-overlay">
        <h2 style="border:none; color:white;">WORLD CHAMPION 2026</h2>
        <div id="champ-name">TEAM</div>
        <div class="actions-row">
            <button class="cyber-btn" onclick="showPath()">üìà PATH TO FINAL</button>
            <button class="cyber-btn close-modal" onclick="closeModal()">CLOSE</button>
        </div>
        <div id="path-panel" style="display:none;"></div>
    </div>
    <canvas id="confetti-canvas"></canvas>

    <h1>// FIFA FIXTURE 2026 //</h1>
    
    <div class="top-controls">
        <button onclick="randomizeGroups()" class="cyber-btn btn-sim">üé≤ SIMULATE GROUPS</button>
        <button onclick="resetTournament()" class="cyber-btn btn-danger">‚ö†Ô∏è RESET DATA</button>
    </div>

    <div id="groups-app" class="groups-container"></div>
    
    <div class="actions-row" id="btn-ro32-container">
        <button id="btn-ro32" onclick="initKnockoutRound('ro32')" class="cyber-btn">>> INITIALIZE ROUND OF 32 >></button>
    </div>

    <div id="ro32-section" class="stage-section">
        <h2>// ROUND OF 32 //</h2>
        <div id="ro32-app" class="bracket-container"></div>
        <div class="actions-row">
            <button onclick="randomizeStage('ro32-app')" class="cyber-btn btn-sim">üé≤ SIMULATE</button>
            <button onclick="initKnockoutRound('r16')" class="cyber-btn">>> TO ROUND OF 16 >></button>
        </div>
    </div>

    <div id="r16-section" class="stage-section">
        <h2>// ROUND OF 16 //</h2>
        <div id="r16-app" class="bracket-container"></div>
        <div class="actions-row">
            <button onclick="randomizeStage('r16-app')" class="cyber-btn btn-sim">üé≤ SIMULATE</button>
            <button onclick="initKnockoutRound('qf')" class="cyber-btn">>> TO QUARTERS >></button>
        </div>
    </div>

    <div id="qf-section" class="stage-section">
        <h2>// QUARTER FINALS //</h2>
        <div id="qf-app" class="bracket-container"></div>
        <div class="actions-row">
            <button onclick="randomizeStage('qf-app')" class="cyber-btn btn-sim">üé≤ SIMULATE</button>
            <button onclick="initKnockoutRound('sf')" class="cyber-btn">>> TO SEMIS >></button>
        </div>
    </div>

    <div id="sf-section" class="stage-section">
        <h2>// SEMI FINALS //</h2>
        <div id="sf-app" class="bracket-container"></div>
        <div class="actions-row">
            <button onclick="randomizeStage('sf-app')" class="cyber-btn btn-sim">üé≤ SIMULATE</button>
            <button onclick="initKnockoutRound('final')" class="cyber-btn">>> TO FINALS >></button>
        </div>
    </div>

    <div id="final-section" class="stage-section">
        <h2>// THE FINALS //</h2>
        <div id="final-app" class="bracket-container" style="align-items: center;"></div>
        <div class="actions-row">
            <button onclick="randomizeStage('final-app')" class="cyber-btn btn-sim">üé≤ SIMULATE FINAL</button>
            <button id="btn-export" onclick="exportBracket()" class="cyber-btn btn-sim" style="border-color:white; color:white;">üì§ EXPORT IMAGE</button>
        </div>
    </div>

<script>
    /* WC 2026 TEAMS */

    const groupsData = {
        "A": ["Mexico", "South Africa", "Korea Rep", "European Play-Off D"],
        "B": ["Canada", "European Play-Off A", "Qatar", "Switzerland"],
        "C": ["Brazil", "Morocco", "Haiti", "Scotland"],
        "D": ["USA", "Paraguay", "Australia", "European Play-Off C"],
        "E": ["Germany", "Cura√ßao", "C√¥te d'Ivoire", "Ecuador"],
        "F": ["Netherlands", "Japan", "European Play-Off B", "Tunisia"],
        "G": ["Belgium", "Egypt", "Iran", "New Zealand"],
        "H": ["Spain", "Cabo Verde", "Saudi Arabia", "Uruguay"],
        "I": ["France", "Senegal", "FIFA Play-Off 2", "Norway"],
        "J": ["Argentina", "Algeria", "Austria", "Jordan"],
        "K": ["Portugal", "FIFA Play-Off 1", "Uzbekistan", "Colombia"],
        "L": ["England", "Croatia", "Ghana", "Panama"]
    };

    let globalStandings = {};
    
    window.onload = function() {
        setRandomNeon();
        renderGroupStage();
        loadState();
        
        window.addEventListener('resize', () => {
            const c = document.getElementById('confetti-canvas');
            c.width = window.innerWidth; c.height = window.innerHeight;
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('champion-overlay');
                if (overlay.style.display === 'flex') closeModal();
            }
        });
    };

    function saveState() {
        const inputs = document.querySelectorAll('input');
        const state = {};
        inputs.forEach(inp => { if(inp.id) state[inp.id] = inp.value; });
        
        const visibleSections = [];
        document.querySelectorAll('.stage-section').forEach(sec => {
            if(sec.style.display === 'block') visibleSections.push(sec.id);
        });

        localStorage.setItem('wc26_v14_save', JSON.stringify({
            inputs: state, visible: visibleSections
        }));
    }

    function loadState() {
        const saved = localStorage.getItem('wc26_v14_save');
        if(!saved) return;
        try {
            const data = JSON.parse(saved);
            for (const [id, val] of Object.entries(data.inputs)) {
                const el = document.getElementById(id);
                if(el) el.value = val;
            }
            Object.keys(groupsData).forEach(g => updateTable(g));

            if(data.visible.includes('ro32-section')) initKnockoutRound('ro32', true);
            if(data.visible.includes('r16-section')) initKnockoutRound('r16', true);
            if(data.visible.includes('qf-section')) initKnockoutRound('qf', true);
            if(data.visible.includes('sf-section')) initKnockoutRound('sf', true);
            if(data.visible.includes('final-section')) initKnockoutRound('final', true);

            
            if(data.visible.includes('ro32-section')) highlightQualifiedThirds();

            setTimeout(() => {
                for (const [id, val] of Object.entries(data.inputs)) {
                    const el = document.getElementById(id);
                    if(el) {
                        el.value = val;
                        if(id.startsWith('m')) {
                            const matchId = id.split('-')[0].substring(1);
                            checkTie(matchId);
                        }
                    }
                }
                updateNeonBasedOnScores();
                checkChampion();
            }, 50);
        } catch(e) { console.error(e); }
    }

    function resetTournament() {
        if(confirm("‚ö†Ô∏è Reset tournament data?")) {
            localStorage.removeItem('wc26_v14_save');
            location.reload();
        }
    }

    
    function updateNeonBasedOnScores() {
        const total = [...document.querySelectorAll('input[id^="m"], input[id^="A"], input[id^="B"]')]
            .filter(i => !i.id.includes('pen'))
            .reduce((s,i) => s + (parseInt(i.value) || 0), 0);
        const hue = (total * 5) % 360; 
        document.documentElement.style.setProperty('--neon', `hsl(${hue}, 100%, 60%)`);
        document.documentElement.style.setProperty('--neon-glow', `hsla(${hue}, 100%, 60%, .4)`);
        document.documentElement.style.setProperty('--neon-dim', `hsla(${hue}, 100%, 60%, .3)`);
    }

    async function exportBracket() {
        stopConfetti();
        const btn = document.getElementById('btn-export');
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "üì∏ CAPTURING...";
        try {
            const canvas = await html2canvas(document.body, {
                backgroundColor: "#050505",
                scale: 2,
                ignoreElements: (element) => element.id === 'champion-overlay'
            });
            const link = document.createElement("a");
            const date = new Date().toISOString().slice(0,10);
            link.download = `WC2026_${date}.png`;
            link.href = canvas.toDataURL();
            link.click();
            btn.innerText = "‚úÖ EXPORTED!";
        } catch(e) { 
            alert("Export failed: " + e.message); 
            btn.innerText = "‚ùå FAILED";
        }
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);
    }

    function getPoissonScore() {
        const lambda = 1.35; let L = Math.exp(-lambda); let p = 1.0; let k = 0;
        do { k++; p *= Math.random(); } while (p > L);
        return k - 1;
    }

    // --- GROUPS ---
    function renderGroupStage() {
        const container = document.getElementById('groups-app');
        container.innerHTML = '';
        for (const [gName, teams] of Object.entries(groupsData)) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="group-title"><span>GROUP ${gName}</span></div>
                <table id="t-${gName}">
                    <thead><tr><th>Team</th><th>P</th><th>GD</th><th>Pts</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="match-list"></div>
            `;
            const matchList = card.querySelector('.match-list');
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    const mId = `${gName}-${i}-${j}`;
                    const row = document.createElement('div');
                    row.className = 'match-item';
                    row.innerHTML = `
                        <span class="team-name t-right">${teams[i]}</span>
                        <div class="inputs-wrapper">
                            <input type="number" id="${mId}-A" min="0" max="20" oninput="handleGroupInput('${gName}', this)">
                            <input type="number" id="${mId}-B" min="0" max="20" oninput="handleGroupInput('${gName}', this)">
                        </div>
                        <span class="team-name t-left">${teams[j]}</span>
                    `;
                    matchList.appendChild(row);
                }
            }
            container.appendChild(card);
            updateTable(gName);
        }
    }

    function handleGroupInput(gName, input) {
        if(input.value < 0) input.value = 0;
        updateTable(gName);
        updateNeonBasedOnScores();
        
        const ro32Section = document.getElementById('ro32-section');
        if(ro32Section.style.display === 'block') {
            const btnContainer = document.getElementById('btn-ro32-container');
            const btn = document.getElementById('btn-ro32');
            btnContainer.style.display = 'flex';
            btn.innerHTML = "‚ö†Ô∏è DATA CHANGED: RE-GENERATE RO32";
            btn.classList.add('btn-update-required');
        }
        saveState();
    }

    function getH2HWinner(gName, teamA, teamB) {
        const teams = groupsData[gName];
        const idxA = teams.indexOf(teamA);
        const idxB = teams.indexOf(teamB);
        if(idxA === -1 || idxB === -1) return 0;

        const first = Math.min(idxA, idxB); const second = Math.max(idxA, idxB);
        const mId = `${gName}-${first}-${second}`;
        const scoreA = document.getElementById(`${mId}-A`).value;
        const scoreB = document.getElementById(`${mId}-B`).value;
        
        if(scoreA === '' || scoreB === '') return 0;
        const sA = parseInt(scoreA); const sB = parseInt(scoreB);
        const teamAScore = (idxA === first) ? sA : sB;
        const teamBScore = (idxB === second) ? sB : sA;
        return teamAScore - teamBScore;
    }

    function updateTable(gName) {
        const teams = groupsData[gName];
        let stats = teams.map(t => ({ name: t, p:0, gf:0, ga:0, gd:0, pts:0, group: gName }));
        for (let i = 0; i < teams.length; i++) {
            for (let j = i + 1; j < teams.length; j++) {
                const mId = `${gName}-${i}-${j}`;
                const iA = document.getElementById(`${mId}-A`);
                const iB = document.getElementById(`${mId}-B`);
                if(iA.value !== '' && iB.value !== '') {
                    const sA = parseInt(iA.value); const sB = parseInt(iB.value);
                    stats[i].p++; stats[i].gf+=sA; stats[i].ga+=sB;
                    stats[j].p++; stats[j].gf+=sB; stats[j].ga+=sA;
                    if(sA > sB) stats[i].pts+=3; else if(sB > sA) stats[j].pts+=3; else { stats[i].pts++; stats[j].pts++; }
                }
            }
        }
        stats.forEach(s => s.gd = s.gf - s.ga);
        stats.sort((a,b) => {
            if(b.pts !== a.pts) return b.pts - a.pts;
            if(b.gd !== a.gd) return b.gd - a.gd;
            if(b.gf !== a.gf) return b.gf - a.gf;
            return getH2HWinner(gName, b.name, a.name); 
        });
        
        globalStandings[gName] = stats;
        const tbody = document.querySelector(`#t-${gName} tbody`);
        tbody.innerHTML = '';
        stats.forEach((s, idx) => {
            let cls = idx < 2 ? `q-${idx+1}` : (idx===2 ? 'q-3' : '');
            tbody.innerHTML += `<tr class="${cls}" id="row-${cleanId(s.name)}"><td>${s.name}</td><td>${s.p}</td><td>${s.gd}</td><td><strong>${s.pts}</strong></td></tr>`;
        });
    }

    // --- KNOCKOUTS ---
    function initKnockoutRound(roundKey, isRestore = false) {
        if (!isRestore) {
            let valid = true;
            let invalidEl = null;

            if(roundKey === 'ro32') {
                const inputs = document.querySelectorAll('#groups-app input');
                for(let inp of inputs) { if(inp.value === '') { valid = false; invalidEl = inp; break; } }
            } else {
                const map = {'r16':'ro32','qf':'r16','sf':'qf','final':'sf'};
                const prevId = `${map[roundKey]}-app`;
                const container = document.getElementById(prevId);
                const inputs = container.querySelectorAll('input:not(.inp-pen)');
                
                for(let i=0; i<inputs.length; i+=2) {
                    const a = inputs[i]; const b = inputs[i+1];
                    if(a.value === '' || b.value === '') { valid = false; invalidEl = a; break; }
                    if(a.value === b.value) {
                        const card = a.closest('.match-card');
                        const pens = card.querySelectorAll('.inp-pen');
                        if(pens[0].value === '' || pens[1].value === '' || pens[0].value === pens[1].value) {
                            valid = false; invalidEl = pens[0]; 
                            alert("Tie game requires valid penalties!"); break;
                        }
                    }
                }
            }

            if(!valid) {
                alert("‚ö†Ô∏è Please complete the current round first!");
                if(invalidEl) { invalidEl.scrollIntoView({behavior:'smooth', block:'center'}); invalidEl.focus(); }
                return;
            }
        }

        let fixtures = [];
        if (roundKey === 'ro32') fixtures = generateRO32Data();
        else fixtures = generateNextRoundData(roundKey);

        const container = document.getElementById(`${roundKey}-app`);
        container.innerHTML = '';
        fixtures.forEach(m => renderMatchCard(container, m));

        const section = document.getElementById(`${roundKey}-section`);
        section.style.display = 'block';
        
        if(roundKey === 'ro32') {
            const btn = document.getElementById('btn-ro32');
            document.getElementById('btn-ro32-container').style.display = 'none';
            btn.innerHTML = ">> INITIALIZE ROUND OF 32 >>";
            btn.classList.remove('btn-update-required');
        }
        
        if(!isRestore) { section.scrollIntoView({ behavior: 'smooth' }); saveState(); }
    }

    function highlightQualifiedThirds() {
        let all3rds = [];
        Object.keys(globalStandings).forEach(g => { if(globalStandings[g][2]) all3rds.push(globalStandings[g][2]); });
        all3rds.sort((a,b) => (b.pts - a.pts) || (b.gd - a.gd) || (b.gf - a.gf));
        const top8 = all3rds.slice(0, 8);
        document.querySelectorAll('.q-best-3').forEach(el => el.classList.remove('q-best-3'));
        top8.forEach(t => {
            const row = document.getElementById(`row-${cleanId(t.name)}`);
            if(row) row.classList.add('q-best-3');
        });
        return top8;
    }

    function generateRO32Data() {
        const top8 = highlightQualifiedThirds();
        const get1 = (g) => globalStandings[g][0].name;
        const get2 = (g) => globalStandings[g][1].name;
        let assigned = [];
        const get3 = (gOpts) => {
            const opts = gOpts.split('/');
            let cand = top8.find(t => opts.includes(t.group) && !assigned.includes(t.name));
            if(!cand) cand = top8.find(t => !assigned.includes(t.name));
            if(cand) { assigned.push(cand.name); return cand.name; }
            return "TBD";
        };

        return [
            { id: 73, h: get2('A'), a: get2('B'), v: "Los Angeles" },
            { id: 74, h: get1('E'), a: get3('A/B/C/D/F'), v: "Boston" },
            { id: 75, h: get1('F'), a: get2('C'), v: "Monterrey" },
            { id: 76, h: get1('C'), a: get2('F'), v: "Houston" },
            { id: 77, h: get1('I'), a: get3('C/D/F/G/H'), v: "New York / New Jersey" },
            { id: 78, h: get2('E'), a: get2('I'), v: "Dallas" },
            { id: 79, h: get1('A'), a: get3('C/E/F/H/I'), v: "Mexico City" },
            { id: 80, h: get1('L'), a: get3('E/H/I/J/K'), v: "Atlanta" },
            { id: 81, h: get1('D'), a: get3('B/E/F/I/J'), v: "San Francisco Bay" },
            { id: 82, h: get1('G'), a: get3('A/E/H/I/J'), v: "Seattle" },
            { id: 83, h: get2('K'), a: get2('L'), v: "Toronto" },
            { id: 84, h: get1('H'), a: get2('J'), v: "Los Angeles" },
            { id: 85, h: get1('B'), a: get3('E/F/G/I/J'), v: "Vancouver" },
            { id: 86, h: get1('J'), a: get2('H'), v: "Miami" },
            { id: 87, h: get1('K'), a: get3('D/E/I/J/L'), v: "Kansas City" },
            { id: 88, h: get2('D'), a: get2('G'), v: "Dallas" }
        ];
    }

    function generateNextRoundData(roundKey) {
        const map = {
            'r16': [ 
                {id:89,s:[74,77],v:"Philadelphia"}, {id:90,s:[73,75],v:"Houston"}, 
                {id:91,s:[76,78],v:"New York / New Jersey"}, {id:92,s:[79,80],v:"Mexico City"}, 
                {id:93,s:[83,84],v:"Dallas"}, {id:94,s:[81,82],v:"Seattle"}, 
                {id:95,s:[86,88],v:"Atlanta"}, {id:96,s:[85,87],v:"Vancouver"} 
            ],
            'qf': [ 
                {id:97,s:[89,90],v:"Boston"}, {id:98,s:[93,94],v:"Los Angeles"}, 
                {id:99,s:[91,92],v:"Miami"}, {id:100,s:[95,96],v:"Kansas City"} 
            ],
            'sf': [ {id:101,s:[97,98],v:"Dallas"}, {id:102,s:[99,100],v:"Atlanta"} ],
            'final': [ 
                {id:103,s:[101,102],v:"Miami (3rd Place)", type:'loser'}, 
                {id:104,s:[101,102],v:"New York / New Jersey (FINAL)", type:'winner'} 
            ]
        };
        return map[roundKey].map(c => {
            const h = c.type === 'loser' ? getLoser(c.s[0]) : getWinner(c.s[0]);
            const a = c.type === 'loser' ? getLoser(c.s[1]) : getWinner(c.s[1]);
            return { id: c.id, h: h, a: a, v: c.v };
        });
    }

    function renderMatchCard(container, m) {
        const div = document.createElement('div');
        let classes = "match-card";
        if (m.id === 103) classes += " bronze-card";
        if (m.id === 104) classes += " final-card gold-card";

        div.className = classes;
        div.innerHTML = `
            <div class="m-header"><span>Match ${m.id}</span><span>${m.v}</span></div>
            <div class="m-body">
                <span class="team-name t-right" id="tn-h-${m.id}">${m.h}</span>
                <div class="inputs-wrapper">
                    <input type="number" id="m${m.id}-A" min="0" oninput="handleKO(${m.id})">
                    <input type="number" id="m${m.id}-B" min="0" oninput="handleKO(${m.id})">
                </div>
                <span class="team-name t-left" id="tn-a-${m.id}">${m.a}</span>
            </div>
            <div class="pen-section" id="pen-sec-${m.id}">
                <span class="pen-label">PENALTIES</span>
                <div class="inputs-wrapper">
                    <input type="number" class="inp-pen" id="pen${m.id}-A" min="0" oninput="handleKO(${m.id})">
                    <span style="color:#666">:</span>
                    <input type="number" class="inp-pen" id="pen${m.id}-B" min="0" oninput="handleKO(${m.id})">
                </div>
            </div>
        `;
        container.appendChild(div);
    }

    function handleKO(mid) {
        checkTie(mid);
        updateNeonBasedOnScores();
        saveState();
        if(mid === 104) checkChampion();
    }

    function checkTie(mid) {
        const sA = document.getElementById(`m${mid}-A`).value;
        const sB = document.getElementById(`m${mid}-B`).value;
        const div = document.getElementById(`pen-sec-${mid}`);
        const pA = document.getElementById(`pen${mid}-A`);
        const pB = document.getElementById(`pen${mid}-B`);

        if(sA !== '' && sB !== '' && parseInt(sA) === parseInt(sB)) {
            div.style.display = 'block';
            if(pA.value !== '' && pB.value !== '' && pA.value === pB.value) {
                pA.classList.add('pen-error'); pB.classList.add('pen-error');
            } else {
                pA.classList.remove('pen-error'); pB.classList.remove('pen-error');
            }
        } else {
            div.style.display = 'none';
            
            pA.value = ''; pB.value = '';
        }
    }

    function getWinner(mid) {
        const h = document.getElementById(`tn-h-${mid}`).innerText;
        const a = document.getElementById(`tn-a-${mid}`).innerText;
        const sA = parseInt(document.getElementById(`m${mid}-A`).value||0);
        const sB = parseInt(document.getElementById(`m${mid}-B`).value||0);
        if(sA === sB) {
            const pA = parseInt(document.getElementById(`pen${mid}-A`).value||0);
            const pB = parseInt(document.getElementById(`pen${mid}-B`).value||0);
            return pA > pB ? h : a;
        }
        return sA > sB ? h : a;
    }

    function getLoser(mid) {
        return getWinner(mid) === document.getElementById(`tn-h-${mid}`).innerText ? 
               document.getElementById(`tn-a-${mid}`).innerText : document.getElementById(`tn-h-${mid}`).innerText;
    }

    // --- SIMULATION ---
    function randomizeGroups() {
        const inputs = document.querySelectorAll('#groups-app input');
        inputs.forEach(i => {
            i.value = getPoissonScore();
            i.classList.add('sim-flash');
            setTimeout(()=>i.classList.remove('sim-flash'), 500);
        });
        
        Object.keys(groupsData).forEach(g => {
            updateTable(g);
            if(document.getElementById('ro32-section').style.display === 'block') {
                const btn = document.getElementById('btn-ro32');
                document.getElementById('btn-ro32-container').style.display = 'flex';
                btn.innerHTML = "‚ö†Ô∏è DATA CHANGED: RE-GENERATE RO32";
                btn.classList.add('btn-update-required');
            }
        });
        updateNeonBasedOnScores();
        saveState();
    }

    function randomizeStage(cid) {
        document.getElementById(cid).querySelectorAll('.match-card').forEach(card => {
            const inputs = card.querySelectorAll('input:not(.inp-pen)');
            inputs.forEach(i => { i.classList.add('sim-flash'); setTimeout(()=>i.classList.remove('sim-flash'), 500); });

            const sA = getPoissonScore(); const sB = getPoissonScore();
            inputs[0].value = sA; inputs[1].value = sB;
            
            const pDiv = card.querySelector('.pen-section');
            const pInp = card.querySelectorAll('.inp-pen');
            
            if(sA === sB) {
                pDiv.style.display = 'block';
                let pA = 3 + Math.floor(Math.random()*3); let pB = 3 + Math.floor(Math.random()*3);
                if(pA === pB) pA++;
                pInp[0].value = pA; pInp[1].value = pB;
                pInp[0].classList.remove('pen-error'); pInp[1].classList.remove('pen-error');
            } else {
                pDiv.style.display = 'none';
                pInp[0].value = ''; pInp[1].value = '';
            }
        });
        updateNeonBasedOnScores();
        saveState();
        if(cid === 'final-app') checkChampion();
    }

    function checkChampion() {
        const mA = document.getElementById('m104-A').value;
        const mB = document.getElementById('m104-B').value;
        if(mA === '' || mB === '') return;
        if(mA === mB) {
            if(document.getElementById('pen104-A').value === '' || document.getElementById('pen104-B').value === '') return;
        }
        triggerConfetti(getWinner(104));
    }

    function triggerConfetti(winner) {
        document.getElementById('champ-name').innerText = winner;
        document.getElementById('champion-overlay').style.display = 'flex';
        startConfetti();
        setTimeout(() => closeModal(), 10000);
    }
    
    function closeModal() { 
        document.getElementById('champion-overlay').style.display = 'none'; 
        stopConfetti(); 
        document.getElementById('path-panel').style.display = 'none';
    }

    function showPath() {
        const champ = getWinner(104);
        const ids = [
            73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,
            89,90,91,92,93,94,95,96,
            97,98,99,100,
            101,102,104
        ];

        let path = [`ü•á PATH TO GLORY: ${champ}\n`];
        ids.forEach(id => {
            const h = document.getElementById(`tn-h-${id}`);
            const a = document.getElementById(`tn-a-${id}`);
            if(!h || !a) return;

            if(h.innerText === champ || a.innerText === champ) {
                const sA = document.getElementById(`m${id}-A`).value || '?';
                const sB = document.getElementById(`m${id}-B`).value || '?';
                const winner = getWinner(id);
                const icon = winner === champ ? '‚úÖ' : '‚ùå';
                path.push(`${icon} Match ${id}: ${h.innerText} ${sA} - ${sB} ${a.innerText}`);
            }
        });

        const panel = document.getElementById("path-panel");
        panel.innerHTML = `<pre style="white-space:pre-wrap;font-size:0.9rem;text-align:left;">${path.join('\n')}</pre>`;
        panel.style.display = "block";
        panel.scrollIntoView({ behavior: "smooth", block: "center" });
    }
    
    function cleanId(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }
    function setRandomNeon() {
        const h = Math.floor(Math.random()*360);
        document.documentElement.style.setProperty('--neon', `hsl(${h}, 100%, 60%)`);
        document.documentElement.style.setProperty('--neon-glow', `hsla(${h}, 100%, 60%, 0.4)`);
        document.documentElement.style.setProperty('--neon-dim', `hsla(${h}, 100%, 60%, 0.3)`);
    }

    let confettiActive = false;
    let particles = [];
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    
    function startConfetti() {
        if(confettiActive) return; confettiActive = true;
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        particles = []; for(let i=0;i<150;i++) particles.push(new Particle());
        animateConfetti();
    }
    function stopConfetti() { 
        confettiActive = false; ctx.clearRect(0,0,canvas.width,canvas.height); 
        particles = []; 
    }
    function animateConfetti() {
        if(!confettiActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animateConfetti);
    }
    class Particle {
        constructor() {
            this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height-canvas.height;
            this.size=Math.random()*8+4; this.speed=Math.random()*3+2;
            this.color=`hsl(${Math.random()*360},100%,50%)`; this.rot=Math.random()*360;
        }
        update() { this.y+=this.speed; this.rot+=2; if(this.y>canvas.height) this.y=-20; }
        draw() {
            ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rot*Math.PI/180);
            ctx.fillStyle=this.color; ctx.fillRect(-this.size/2,-this.size/2,this.size,this.size);
            ctx.restore();
        }
    }
</script>
</body>
</html>
